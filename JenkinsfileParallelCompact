@Library('my-shared-library') _
node ('master'){
    def parallelBranches = ["linux-x86":["linux","x86","centos"],"linux-x86_64":["linux","x86_64","centos"]]
    def branches = [:]

    parallelBranches.each { branch ->
        def branchName = branch.key
        def agentLabel = branch.value[2]
        branches[branchName] = {
            node (agentLabel){
                def platform_version = branch.value[1]
                def os_version = branch.value[0]
                stage('Checkout repository '+os_version+' '+platform_version+'.') {
                    checkout poll: false, scm: [$class: 'GitSCM', branches: [[name: 'refs/heads/master']], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/uladzimiramelyanovich/curl.git']]]
                }
                stage('Build '+os_version+' '+platform_version+'.') {
                    script {
                        if ( os_version == "linux" ) {
                            parallelScript.linux("platform" : "${platform_version}")
                        } else if ( os_version == "windows" ) {
                            parallelScript.windows("platform" : "${platform_version}")
                        } else {
                            println('Unsupported os version.')
                        }    
                    }
                }
            }
        }
    }
    parallel branches
}